<!DOCTYPE html>
<meta charset="utf-8">

<body>

<script src="js/node_scripts/d3.min.js"></script>
<script src="js/node_scripts/d3.geo.projection.min.js"></script>
<script src="js/node_scripts/topojson.min.js"></script>
<script src="js/node_scripts/three.min.js"></script>

<!--<script src="node_modules/d3/d3.js"></script>-->
<!--<script src="node_modules/d3-geo-projection/d3.geo.projection.js"></script>-->
<!--<script src="node_modules/topojson/build/topojson.js"></script>-->
<!--<script src="node_modules/three/three.js"></script>-->


<script>

//    var projection = d3.geo.kavrayskiy7();
    var projection = d3.geo.equirectangular()
        .translate([512, 256]).scale(163);

    country_name_val_map = {};
    d3.tsv("data/countries_with_vals.tsv", function(error, country_val) {

        country_val.forEach(function (country) {
            var name = country["Country"];
            country_name_val_map[name] = country["Value"];
        });
    });

    country_id_name_map = {};
    d3.csv("data/iso_3166.csv", function(error, iso_data) {
        iso_data.forEach(function(country) {
            var country_name = country["name"];
            var country_id = country["country-code"];
            country_id_name_map[country_id] = country_name;
        });
    });

    d3.json("data/world-50m.json", function(error, world) {

        var width = 1024;
        var height = 512;

        var canvas = d3.select("body").append("canvas")
            .attr("width", width)
            .attr("height", height);

        var context = canvas.node().getContext("2d");

        var color = d3.scale.linear()
            .domain([0, 100])
            .interpolate(d3.interpolateHcl)
            .range([d3.rgb("#ffffff"), d3.rgb("#00ff00")]);
        var graticule = d3.geo.graticule();

        var path = d3.geo.path()
            .projection(projection)
            .context(context);

        context.strokeStyle = '#000';
        context.beginPath();
        path(graticule());
        context.lineWidth = .5;
        context.stroke();

        context.strokeStyle = '#333';
        context.beginPath();
        path(graticule.outline());
        context.lineWidth = 1.5;
        context.stroke();


            var countries = topojson.feature(world, world.objects.countries).features;
    //        var neighbors = topojson.neighbors(world.objects.countries.geometries);

            countries.forEach(function(d) {

                var country_name = country_id_name_map[d.id];
                var country_value = country_name_val_map[country_name];

                var country_color = color(country_value);
                context.fillStyle = country_color;

                context.beginPath();
                path(d);
                context.fill();
            });


        // Setup Three scene
        var scene = new THREE.Scene();

        // Setup camera
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 6000);
        camera.position.z = 500;

        // Setup THREE renderer
        var renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Add light
        var light = new THREE.HemisphereLight('#fff', '#666', 1.5);
        light.position.set(0, 500, 0);
        scene.add(light);

        // Generate material (and color) for base globe
        var waterMaterial = new THREE.MeshBasicMaterial({color: '#003', transparent: true});

        // Setup a geometry
        var sphere = new THREE.SphereGeometry(200, 100, 100);

        // Generate a mesh layer based on materials and geometry
        var baseLayer = new THREE.Mesh(sphere, waterMaterial);

        // Generate a texture
        var mapTexture = new THREE.Texture(canvas.node());
        console.log(mapTexture);
        mapTexture.needsUpdate = true;

        var mapMaterial = new THREE.MeshBasicMaterial({map: mapTexture, transparent: true});
        var mapLayer = new THREE.Mesh(sphere, mapMaterial);

        console.log(mapLayer);

        var root = new THREE.Object3D();
        root.add(baseLayer);
        root.add(mapLayer);
        scene.add(root);

        function render() {
            root.rotation.y += 0.02;
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        }

        render();
    });

</script>

</body>
